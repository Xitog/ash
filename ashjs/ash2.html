<!DOCTYPE html>
<html lang="en">

<head>
    <title>Ash Live</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="https://xitog.github.io/dgx/img/favicon.ico" type="image/x-icon" />
    <link rel="shortcut icon" href="https://xitog.github.io/dgx/img/favicon.ico" type="image/x-icon" />
    <link href="http://fonts.googleapis.com/css?family=Lobster" rel="stylesheet" type="text/css" />
    <link href="ash.css" rel="stylesheet" />
    <script type="module" src="./lexer.mjs"></script>
    <script type="module" src="./parser.mjs"></script>
    <script type="module" src="./interpreter.mjs"></script>
    <script type="module" stc="./translator.mjs"></script>
    <script type="module">
        //-----------------------------------------------------------------
        // Imports
        //-----------------------------------------------------------------
        import { Lexer, Language } from "./lexer.mjs";
        import { Parser } from "./parser.mjs";
        import { Interpreter, VERSION } from "./interpreter.mjs";
        //import { Translator} from "./translator.mjs";

        //-----------------------------------------------------------------
        // Functions
        //-----------------------------------------------------------------
        function $(element) {
            let obj = document.getElementById(element);
            if (obj === null) {
                let msg = "No element found: " + element;
                alert(msg);
                throw new Error(msg);
            }
            return obj;
        }

        function clear() {
            $("expr_input").value = '';
        }

        function run() {
            console.log('start of run');
            let code = $("expr_input").value;
            let tokens = new Lexer('ash').lex(code);
            console.log('Parsing :');
            let root = new Parser().parse(tokens, true);
            console.log('Interpreter :');
            let result = GlobalInterpreter.do(root);
            let output = document.createElement("pre");
            console.log('End of execution');
            output.innerHTML = '<span class="command">&gt;&gt;&gt; ' + code + '</span>\n' + result;
            $("console").style.display = 'block';
            $("console").prepend(output);
            console.log('>>>', result);
            console.log('end of run');
        }

        function openOrCloseOptions() {
            let elem = $('option_panel');
            if (elem.style.display === "block") {
                elem.style.display = "none";
            } else {
                elem.style.display = "block";
            }
        }

        function main() {
            console.log('start of main');
            $("version").innerHTML = "v" + VERSION;
            GlobalInterpreter = new Interpreter();
            $("expr_button_clear").onclick = clear;
            $("expr_button_run").onclick = run;
            $("main_form").onsubmit = function () {
                run();
                return false;
            }
            $("expr_button_run").disabled = false;
            $("options_button").onclick = openOrCloseOptions;
            console.log("end of main");
        }

        let data;
        await fetch('./languages/ash.lang.json').then(response => response.json().then(
            data =>
                Language.readDefinition(data)
        ));

        let GlobalInterpreter;

        window.onload = function() { main(); };

    </script>
</head>

<body id="body">
    <!-- content -->
    <div id="container">
        <div>
            <h1>Ash</h1>
            <form id="main_form" name="main">
                <fieldset id="fieldset_expr">
                    <legend id="expr_legend">Type your expression</legend>
                    <input id="expr_button_clear" type="button" value="Clear"/>
                    <input id="expr_input" name="expr" type="text" size="60" />
                    <input id="expr_button_run" type="button" value="Run" disabled/>
                </fieldset>
            </form>
            <div id="console"></div>
            <canvas id="screen"></canvas>
            <button id="options_button">Options</button>
            <div id="option_panel">
                <fieldset>
                    <legend>Layout</legend>
                    <input id="column" name="layout" type="radio" checked />
                    <label for="column">Column</label>
                    <input id="sidebyside" name="layout" type="radio" />
                    <label for="sidebyside">Side by side</label>
                </fieldset>
                <fieldset>
                    <legend>Choose</legend>
                    <input id="expression" name="mode" type="radio" checked />
                    <label for="expression">Expression</label>
                    <input id="instructions" name="mode" type="radio" />
                    <label for="instructions">Instructions</label>
                </fieldset>
            </div>
        </div>
    </div>
    <div id="version"></div>
</body>

</html>
